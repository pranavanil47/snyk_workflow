name: Snyk Full Security Scan

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  snyk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install Snyk CLI
      - name: Set up Snyk CLI
        uses: snyk/actions/setup@master
        with:
          snyk-version: latest
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_API_TOKEN }}

      # Snyk Code (SAST) scan
      - name: Snyk Code test
        continue-on-error: true
        run: snyk code test --json-file-output=snyk-code.json

      # Snyk Open Source (SCA) scan
      - name: Snyk Open Source test
        continue-on-error: true
        run: snyk test --all-projects --json-file-output=snyk-oss.json

      # Snyk Infrastructure as Code scan
      - name: Snyk IaC test
        continue-on-error: true
        run: snyk iac test --report --json-file-output=snyk-iac.json

      # Docker image build (if Dockerfile exists)
      - name: Build Docker image (if present)
        if: hashFiles('Dockerfile') != ''
        run: docker build -t temp-snyk-image .

      # Snyk Container scan (if built)
      - name: Snyk Container test (if Dockerfile exists)
        if: hashFiles('Dockerfile') != ''
        continue-on-error: true
        run: snyk container test temp-snyk-image --file=Dockerfile --json-file-output=snyk-container.json

      # SSH Setup for upload
      - name: Setup SSH for Upload
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 34.59.19.208 >> ~/.ssh/known_hosts

      # Upload JSON reports to VM
      - name: Upload JSON reports to VM
        if: always()
        run: |
          REMOTE_DIR="/home/pranavanil123/snyk"
          scp snyk-code.json pranavanil123@34.59.19.208:$REMOTE_DIR/ || true
          scp snyk-oss.json pranavanil123@34.59.19.208:$REMOTE_DIR/ || true
          scp snyk-iac.json pranavanil123@34.59.19.208:$REMOTE_DIR/ || true
          if [ -f snyk-container.json ]; then
            scp snyk-container.json pranavanil123@34.59.19.208:$REMOTE_DIR/
          fi

      # Cleanup SSH key
      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/id_rsa
